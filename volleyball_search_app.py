import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import streamlit as st 
import numpy as np
import matplotlib.font_manager as fm
import os

# =================================================================
# 0. ç’°å¢ƒé…ç½®èˆ‡å­—é«”è¨­ç½®
# =================================================================

st.set_page_config(layout="wide")
st.title("ğŸ å°ç£ç”·å­æ’çƒæ•¸æ“šèˆ‡æ­·å²åˆ†æ (TVL / T.P.V.L. åŸºç¤)") # æ¨™é¡Œæ›´æ–°
st.markdown("---")

# --- ä¸­æ–‡å­—é«”è¨­ç½® (ç¶­æŒåŸç©©å®šè¨­å®š) ---
font_path = './NotoSansCJKtc-Regular.otf' 

try:
    if os.path.exists(font_path):
        fm.fontManager.addfont(font_path)
        plt.rcParams['font.family'] = 'Noto Sans CJK TC' 
        plt.rcParams['axes.unicode_minus'] = False 
        st.sidebar.success("ğŸ‰ ä¸­æ–‡å­—é«”å·²æˆåŠŸåŠ è¼‰ï¼")
    else:
        st.sidebar.error(f"ğŸš¨ æ‰¾ä¸åˆ°å­—é«”æ–‡ä»¶æ–¼: {font_path}")
        plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'Arial'] 
        plt.rcParams['axes.unicode_minus'] = False
except Exception as e:
    st.sidebar.error(f"ğŸš¨ å­—é«”åŠ è¼‰éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {e}")
    plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'Arial'] 
    plt.rcParams['axes.unicode_minus'] = False


# =================================================================
# 1. æ•¸æ“šå®šç¾©èˆ‡è¼‰å…¥ (å°ç£ç”·å­æ’çƒæ•¸æ“š)
# =================================================================

@st.cache_data
def load_data():
    
    # --- å°ç£ç”·å­æ’çƒéšŠä¼åˆ—è¡¨ ---
    TVL_TEAMS = [
        'å±æ±å°é›»ç”·æ’', 'è‡ºä¸­å¤ªé™½ç¥', 'è‡ºåŒ—èˆ‰é‡è¨“ç·´ä¸­å¿ƒ', 'é€£èŠç”·æ’', 
        'æ¡ƒåœ’è‡ºç£ç”¢ç‰©', 'conti'
    ]
    
    # --- 1.1 çƒå“¡å€‹äººæ•¸æ“š (æ¨¡æ“¬å°ç£ TVL æ ¸å¿ƒçƒå“¡æ•¸æ“š) ---
    data = {
        'å§“å': ['é»ƒå»ºé€¢', 'æˆ´å„’è¬™', 'å³å®—è»’', 'é¡æŒ¯ç™¼', 'æ—å®œæš‰', 'æ—è¼…æƒŸ', 'çŸ³ä¿®æ™º', 'ç„¦ç’¿èª ', 'åŠ‰ä½³æ˜Œ', 'è¨±ç¾ä¸­', 'é™³è£•æ˜‡', 'è¬é›…ä»', 'é™³æ˜­éŠ˜', 'æèˆˆåœ‹', 'æ´ªç†™éˆ', 
                 'é¡å»·ç¾½', 'æ—è–é–”', 'é™³å»ºå»·', 'è¨±ç¿æ©', 'é»ƒå£«å±•', 'å¼µå–„æº', 'é™³æ˜±è±ª', 'è”¡ç§‰é¾', 'ææ±æ½¤', 'è©¹è© å“²', 'ç›§æ¸…éŠ“', 'è‘£åŠ›å„„', 'æ´ªæ¦®ç™¼', 'å‘‚å§œè€€å‡±', 'ç°¡å‰å€«'],
        
        'ä½ç½®': ['OP', 'S', 'OP', 'MB', 'MB', 'OH', 'MB', 'OH', 'OP', 'OH', 'OH', 'OH', 'MB', 'S', 'OP', 
                 'S', 'L', 'OP', 'MB', 'OH', 'OH', 'MB', 'OH', 'S', 'L', 'S', 'MB', 'OH', 'MB', 'L'],
        
        'éšŠä¼': [
            'å±æ±å°é›»ç”·æ’', 'è‡ºåŒ—èˆ‰é‡è¨“ç·´ä¸­å¿ƒ', 'è‡ºä¸­å¤ªé™½ç¥', 'å±æ±å°é›»ç”·æ’', 'é€£èŠç”·æ’', 'è‡ºä¸­å¤ªé™½ç¥', 'æ¡ƒåœ’è‡ºç£ç”¢ç‰©', 'conti', 'é€£èŠç”·æ’', 'æ¡ƒåœ’è‡ºç£ç”¢ç‰©', 'è‡ºä¸­å¤ªé™½ç¥', 'conti', 'è‡ºåŒ—èˆ‰é‡è¨“ç·´ä¸­å¿ƒ', 'æ¡ƒåœ’è‡ºç£ç”¢ç‰©', 'conti', 
            'å±æ±å°é›»ç”·æ’', 'è‡ºä¸­å¤ªé™½ç¥', 'è‡ºåŒ—èˆ‰é‡è¨“ç·´ä¸­å¿ƒ', 'æ¡ƒåœ’è‡ºç£ç”¢ç‰©', 'å±æ±å°é›»ç”·æ’', 'å±æ±å°é›»ç”·æ’', 'é€£èŠç”·æ’', 'è‡ºåŒ—èˆ‰é‡è¨“ç·´ä¸­å¿ƒ', 'é€£èŠç”·æ’', 'é€£èŠç”·æ’', 'è‡ºä¸­å¤ªé™½ç¥', 'å±æ±å°é›»ç”·æ’', 'è‡ºåŒ—èˆ‰é‡è¨“ç·´ä¸­å¿ƒ', 'conti', 'æ¡ƒåœ’è‡ºç£ç”¢ç‰©'
        ],
        
        'ç¸½å¾—åˆ†': [580, 150, 450, 320, 280, 390, 240, 480, 350, 410, 380, 450, 250, 120, 350, 
                  100, 0, 300, 200, 350, 400, 250, 300, 130, 0, 110, 220, 280, 250, 0],
        'ç¸½é€²æ”»æ¬¡æ•¸': [950, 100, 700, 400, 350, 650, 320, 800, 600, 650, 600, 750, 300, 90, 600, 
                      80, 0, 550, 250, 600, 700, 350, 500, 100, 0, 90, 350, 500, 300, 0],
        'æˆåŠŸæ‰£çƒæ•¸': [500, 70, 380, 280, 240, 350, 180, 420, 300, 360, 340, 400, 200, 60, 300, 
                      50, 0, 250, 170, 300, 350, 200, 250, 70, 0, 50, 180, 250, 200, 0],
        
        'æ¥ç™¼çƒç¸½æ¬¡æ•¸': [50, 10, 400, 10, 5, 550, 15, 650, 20, 400, 500, 600, 10, 5, 450, 
                        8, 700, 50, 10, 450, 500, 5, 80, 5, 750, 10, 15, 300, 10, 700],
        'æ¥ç™¼çƒæˆåŠŸæ¬¡æ•¸': [25, 5, 200, 3, 0, 300, 0, 350, 5, 200, 250, 300, 0, 2, 200, 
                          2, 350, 20, 0, 220, 250, 0, 30, 0, 400, 3, 0, 150, 0, 350],
        
        'ç™¼çƒå¾—åˆ†': [30, 10, 20, 15, 10, 15, 5, 25, 15, 30, 25, 20, 10, 15, 20, 
                    10, 0, 15, 10, 20, 25, 15, 10, 5, 0, 10, 15, 10, 10, 0],
        'æ””ç¶²å¾—åˆ†': [20, 30, 50, 25, 30, 25, 5, 35, 35, 20, 30, 30, 40, 45, 30, 
                    40, 0, 35, 20, 30, 25, 35, 40, 50, 0, 40, 30, 20, 40, 0],
        
        'ç¸½èˆ‰çƒæ¬¡æ•¸': [0, 2500, 0, 0, 0, 0, 0, 0, 0, 1800, 0, 0, 0, 1500, 0, 
                      2000, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1200, 0, 0, 0, 0],
        'èˆ‰çƒæˆåŠŸæ¬¡æ•¸': [0, 1200, 0, 0, 0, 0, 0, 0, 0, 800, 0, 0, 0, 700, 0, 
                        900, 0, 0, 0, 0, 0, 0, 0, 0, 0, 600, 0, 0, 0, 0],
        
        'èº«é«˜ (cm)': [193, 180, 186, 192, 200, 185, 190, 188, 192, 178, 187, 190, 195, 176, 188, 
                      175, 175, 193, 190, 187, 188, 196, 191, 185, 172, 175, 190, 180, 198, 170],
        'é«”é‡ (kg)': [88, 70, 80, 85, 95, 78, 85, 80, 85, 68, 80, 70, 90, 65, 80, 
                      68, 65, 88, 80, 75, 85, 90, 82, 75, 60, 70, 80, 75, 90, 65],
        'ç²çç´€éŒ„': [
            'MVP', 'Best Setter', 'Best OH', 'Best MB', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 
            'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡', 'ç„¡'
        ]
    }
    df = pd.DataFrame(data)

    # --- 1.2 æ¨¡æ“¬æ­·å¹´çƒéšŠæ¯”è³½æˆç¸¾ (TVL æ­·å²æ•¸æ“š) ---
    historical_data = {
        'å¹´ä»½': [2024, 2023, 2022, 2024, 2023, 2022, 2024, 2023, 2022],
        'éšŠä¼': [
            'å±æ±å°é›»ç”·æ’', 'å±æ±å°é›»ç”·æ’', 'å±æ±å°é›»ç”·æ’', 
            'è‡ºä¸­å¤ªé™½ç¥', 'è‡ºä¸­å¤ªé™½ç¥', 'è‡ºä¸­å¤ªé™½ç¥', 
            'è‡ºåŒ—èˆ‰é‡è¨“ç·´ä¸­å¿ƒ', 'è‡ºåŒ—èˆ‰é‡è¨“ç·´ä¸­å¿ƒ', 'è‡ºåŒ—èˆ‰é‡è¨“ç·´ä¸­å¿ƒ'
        ],
        'è¯è³½æ’å': [1, 1, 2, 3, 2, 1, 2, 3, 3],
        'ç¸½æ±ºè³½çµæœ': ['å† è»', 'å† è»', 'äºè»', 'å­£è»', 'äºè»', 'å† è»', 'äºè»', 'å­£è»', 'å­£è»']
    }
    df_history = pd.DataFrame(historical_data)

    # --- 1.3 æŒ‡æ¨™è¨ˆç®— ---
    df['é€²æ”»æ±ºå®šç‡'] = np.where(df['ç¸½é€²æ”»æ¬¡æ•¸'] > 0, (df['æˆåŠŸæ‰£çƒæ•¸'] / df['ç¸½é€²æ”»æ¬¡æ•¸']) * 100, 0)
    df['æ¥ç™¼çƒæˆåŠŸç‡'] = np.where(df['æ¥ç™¼çƒç¸½æ¬¡æ•¸'] > 0, (df['æ¥ç™¼çƒæˆåŠŸæ¬¡æ•¸'] / df['æ¥ç™¼çƒç¸½æ¬¡æ•¸']) * 100, 0)
    df['èˆ‰çƒæ•ˆç‡'] = np.where(df['ç¸½èˆ‰çƒæ¬¡æ•¸'] > 0, (df['èˆ‰çƒæˆåŠŸæ¬¡æ•¸'] / df['ç¸½èˆ‰çƒæ¬¡æ•¸']) * 100, 0)
    df['æ‰£çƒå¾—åˆ†'] = df['ç¸½å¾—åˆ†'] - df['ç™¼çƒå¾—åˆ†'] - df['æ””ç¶²å¾—åˆ†']
    
    return df, df_history

df, df_history = load_data()
all_teams = sorted(df['éšŠä¼'].unique())

# =================================================================
# 2. äº’å‹•å¼ç¯©é¸å™¨ (å´é‚Šæ¬„)
# (é€™éƒ¨åˆ†ç¶­æŒä¸è®Š)
# =================================================================

st.sidebar.header("ğŸ¯ é¸æ“‡çƒå“¡")

# æ­¥é©Ÿ 1: é¸æ“‡éšŠä¼
selected_team = st.sidebar.selectbox(
    "1. é¸æ“‡æœå‹™éšŠä¼:",
    options=[''] + all_teams,
    index=0
)

# æ­¥é©Ÿ 2: é¸æ“‡çƒå“¡ (åªæœ‰é¸äº†éšŠä¼æ‰é¡¯ç¤º)
selected_player_name = ''
if selected_team:
    players_in_team = df[df['éšŠä¼'] == selected_team]['å§“å'].unique()
    selected_player_name = st.sidebar.selectbox(
        "2. é¸æ“‡çƒå“¡:",
        options=players_in_team
    )

st.sidebar.markdown("---")


# =================================================================
# 3. ä¸»é é¢ï¼šçƒå“¡å€‹äººæª”æ¡ˆé¡¯ç¤º (é€™éƒ¨åˆ†ç¶­æŒä¸è®Š)
# =================================================================

if not selected_player_name:
    st.info("è«‹åœ¨å´é‚Šæ¬„é¸æ“‡ä¸€æ”¯éšŠä¼å’Œä¸€ä½çƒå“¡ï¼Œä»¥æŸ¥çœ‹å€‹äººåˆ†æå ±å‘Šã€‚")
else:
    # ç²å–é¸å®šçƒå“¡çš„æ•¸æ“š
    player_data = df[df['å§“å'] == selected_player_name].iloc[0]
    
    st.header(f"ğŸ‘¤ {selected_player_name} - å€‹äººè¡¨ç¾å ±å‘Š")
    st.subheader(f"ç›®å‰æœå‹™éšŠä¼ï¼š{player_data['éšŠä¼']} ({player_data['ä½ç½®']})")
    
    # å‰µå»º Tabs
    tab1, tab2 = st.tabs(["ğŸ“Š æ•¸æ“šèˆ‡è³‡æ–™", "ğŸ“œ çƒéšŠæ­·å²æˆç¸¾"])

    with tab1:
        st.subheader("1. åŸºç¤æ•¸æ“šèˆ‡é«”å‹è³‡æ–™")
        
        col1, col2, col3 = st.columns(3)
        col1.metric("èº«é«˜", f"{player_data['èº«é«˜ (cm)']} cm")
        col2.metric("é«”é‡", f"{player_data['é«”é‡ (kg)']} kg")
        col3.metric("ä½ç½®", player_data['ä½ç½®'])
        
        st.markdown(f"**ğŸ… éå¾€ç²çç´€éŒ„ï¼š** {player_data['ç²çç´€éŒ„']}")
        st.markdown("---")

        st.subheader("2. è³½å­£æ ¸å¿ƒè¡¨ç¾ (2025 æ¨¡æ“¬æ•¸æ“š)")
        
        # é¡¯ç¤ºæ ¸å¿ƒæ•ˆç‡æŒ‡æ¨™ 
        colA, colB, colC, colD = st.columns(4)
        colA.metric("ç¸½å¾—åˆ†", f"{player_data['ç¸½å¾—åˆ†']} åˆ†")
        colB.metric("é€²æ”»æ±ºå®šç‡", f"{player_data['é€²æ”»æ±ºå®šç‡']:.1f} %", help="æˆåŠŸæ‰£çƒæ•¸ / ç¸½é€²æ”»æ¬¡æ•¸")
        colC.metric("æ¥ç™¼çƒæˆåŠŸç‡", f"{player_data['æ¥ç™¼çƒæˆåŠŸç‡']:.1f} %", help="æˆåŠŸæ¥ç™¼æ¬¡æ•¸ / ç¸½æ¥ç™¼æ¬¡æ•¸")
        colD.metric("èˆ‰çƒæ•ˆç‡", f"{player_data['èˆ‰çƒæ•ˆç‡']:.1f} %", help="èˆ‰çƒæˆåŠŸæ¬¡æ•¸ / ç¸½èˆ‰çƒæ¬¡æ•¸ã€‚éèˆ‰çƒå“¡æœƒé¡¯ç¤º 0.0 %ã€‚")

        st.subheader("3. å¾—åˆ†æ§‹æˆåˆ†æåœ–")

        # ç¹ªè£½å–®ä¸€çƒå“¡çš„å¾—åˆ†æ§‹æˆåœ“é¤…åœ–
        score_data = pd.Series({
            'æ‰£çƒå¾—åˆ†': player_data['æ‰£çƒå¾—åˆ†'],
            'ç™¼çƒå¾—åˆ†': player_data['ç™¼çƒå¾—åˆ†'],
            'æ””ç¶²å¾—åˆ†': player_data['æ””ç¶²å¾—åˆ†']
        })
        
        # ç¹ªè£½åœ“é¤…åœ–
        fig, ax = plt.subplots(figsize=(7, 7))
        wedges, texts, autotexts = ax.pie(score_data, 
                                          labels=score_data.index,
                                          autopct='%1.1f%%', 
                                          startangle=90, 
                                          colors=['#FF5733', '#33FF57', '#3357FF'])
        
        ax.axis('equal') 
        ax.set_title(f"{selected_player_name} å¾—åˆ†ä¾†æºåˆ†ä½ˆ")
        fig.tight_layout()
        st.pyplot(fig)


    with tab2:
        st.subheader(f"ğŸ“œ {player_data['éšŠä¼']} æ­·å¹´æ¯”è³½æˆç¸¾ (2022-2024 è¯è³½æ’å)")
        
        team_history = df_history[df_history['éšŠä¼'] == player_data['éšŠä¼']].sort_values(by='å¹´ä»½', ascending=False)
        
        if team_history.empty:
             st.warning(f"ğŸš¨ æ¨¡æ“¬æ­·å²æ•¸æ“šä¸­æ²’æœ‰æ‰¾åˆ° {player_data['éšŠä¼']} çš„ç´€éŒ„ã€‚")
        else:
            st.dataframe(
                team_history.rename(columns={'è¯è³½æ’å': 'è³½å­£æ’å'}),
                use_container_width=True
            )
            
            # ç¹ªè£½æ­·å²æ’åè¶¨å‹¢åœ–
            plt.figure(figsize=(10, 5))
            sns.lineplot(data=team_history.sort_values(by='å¹´ä»½'), x='å¹´ä»½', y='è¯è³½æ’å', marker='o')
            plt.gca().invert_yaxis() 
            plt.yticks(team_history['è¯è³½æ’å'].unique())
            plt.xticks(team_history['å¹´ä»½'].unique()) 
            plt.title(f"{player_data['éšŠä¼']} è¯è³½æ’åè¶¨å‹¢")
            plt.xlabel('å¹´ä»½')
            plt.ylabel('è¯è³½æ’å (æ•¸å­—è¶Šå°è¶Šå¥½)')
            st.pyplot(plt.gcf())
            
st.markdown("---")
st.caption("æ•¸æ“šä¾†æºï¼šæ¨¡æ“¬å°ç£ TVL 2024-2025 è³½å­£å€‹äººæ•¸æ“šèˆ‡æ­·å²æˆ°ç¸¾ã€‚")
